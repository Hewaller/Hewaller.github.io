---
title: '小程序云开发 —— taro'
date: 2020-04-08
categories: miniApp # 分类只能有1个
tags: # 标签可以有多个
  - miniApp
---

小程序云开发探索笔记

<!-- more -->

### 小程序模版

区别于普通的小程序：

- 目录结构 [官网模版](https://nervjs.github.io/taro/docs/wxcloud.html)
- 使用微信开发者工具调试项目，请将项目 **整个文件夹** 作为运行目录。
- `project.config.json` 中 `miniprogramRoot` 的启动目录设置为 `client/dist/`
- `cloudfunctionRoot` 设置目录为 `cloud/functions/`
- 入口文件`src/app.jsx` 添加

```js
   componentDidMount() {
       wx.cloud.init({
         env: "环境ID"
       });
   }
```

### 数据库

云开发提供了一个 JSON 数据库,一个数据库可以有多个集合（相当于关系型数据中的表），集合可看做一个 JSON 数组，数组中的每个对象就是一条记录，记录的格式是 JSON 对象。

建立数据库步骤：

- 小程序内点击云开发 - 数据库
- 新建一个集合（表）
- 对应集合中添加需要的字段，JSON 格式。
- 索引字段默认为 `_id`, 使用系统自动生成的 id

### 云函数的开发和调试

1. 建立好云函数文件夹后，打开开发者开发工具，右键云函数文件夹，新建 Node.js 云函数。会自动生成一个文件夹，并且同时部署到远程

![image](https://pic.downk.cc/item/5e8ae285504f4bcb04f75c07.jpg)

> 文件结构如下

```js
├── sum                         云函数名
│   ├── config.json             配置文件
│   ├── package.json            依赖包
│   ├── index.js                云函数主体

```

2. 修改新建的云函数
   > 一开始发现怎么改 `index.js` 都不起作用，原来是修改后远程的云函数并未自动更新，解决方案：

- 修改后直接上传和部署：每次修改都得重新部署，麻烦
- 云函数本地调试 [官网文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/functions/local-debug.html)

![image](https://pic.downk.cc/item/5e8ae56b504f4bcb04f996cd.jpg)

> 本地调试云函数首先得安装依赖 `npm i`，同时监听文件的更改，部署到云端不上传 node_modules

### 云函数的注意事项和总结

```js
// 云函数入口文件
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()
const _ = db.command

exports.main = async (event, context) => {
  try {
    return await db
      .collection('todos')
      .where({
        _id: _.in(event.ids),
      })
      .remove()
  } catch (e) {
    console.error(e)
  }
}
```

- 异步问题：可以使用 generator 语法
- 批量处理多条数据可以使用 `where` 语句，搭配 `command` 中的方法
- `node_modules`： 本地调试和部署到云端，前者需要，后者不需要
- 调用云函数： `wx.cloud.callFunction` ，要根据返回的 `result` 数据判断是是否执行成功，云函数执行失败，返回的数据可能不包含 `result` 字段或者为 `null`
