---
layout: post
title: Ant design Vue From
date: 2019-03-09
categories: blog
tags: [antd, UI, from]
description: ant-design-UI框架
---

# `element-ui` 和 `ant-design-vue` form 表单验证

## Ant-design-vue 的表单验证

```html
<a-form-item v-bind="mapLayout" label="图片附件">
  <hotel-upload
    v-decorator="['attach', {initialValue: [],rules:[{validator: imageLengthValidate}]}]"
    :limit="100"
    :validate="validateImageSize"
  >
  </hotel-upload>
</a-form-item>
```

使用到的表单验证一般都会定义在 `rules` 中，但是也不能排除特出情况

> 例如在图片上传时需要判断图片的 size，主要氛围两种情况：

- 在上传到服务器之前，使用 `new Image()` 和 `URL.createObjectURL(file)`提前获得本地图片大小判断，不符合 size 就阻止上传；
- 上传之后在提交时触发提交事件，主动触发表单的验证，使用图片的 URL 实例化本地图片在判断是否合规，决定是否可以提交

### 简单的自定义表单验证

[为什么 form 验证的 callback 必须被调用](https://github.com/ant-design/ant-design/issues/5155)

```js
// 表单中的input或者其他组件
// v-decorator ="['name', {initialValue: '', rules: [{required: true, message: 'some....'}, {validator: validator}]}]"

validator(file, value, callback) {
    if(value === '....'){
        // 验证没通过
        callback('验证没通过')
    } else {
        callback()
    }
    // 无论验证是否通过，callback必须被调用
}

```

> 以此类推，我们可以为表单添加多个验证规则 `rules:[{required: true, message: 'some....'}, {validator: imageLengthValidate}]`

## 验证图片宽高大小的方式

1. 上传至服务器之后的验证（通过表单验证的形式）

```js
// 验证方法 utils.js
export function imageInfo(src) {
  return new Promise((resolve, reject) => {
    // 通过图片上传后的地址来验证
    if (!/[jpeg|png|jpg|gif|svg|ico]/gi.test(src)) {
      message.warning('请上传图片类型文件')
      return
    }
    const img = new Image()
    img.src = src
    img.onload = function() {
      const { width, height } = this
      resolve({
        height,
        width
      })
    }
    img.onerror = e => {
      message.error('图片加载失败')
      reject(e)
    }
  })
}

//表单中附加的验证方法
const imagesSize = async (file, value, callback) => {
  let error = undefined
  // 因为验证方法中使用是异步，所以不能使用map来对数组进行遍历，使用for循环可以很好的解决这这个问题
  for (let i = 0; i < value.length; i++) {
    // 循环遍历验证，但是问题是即使某张图验证失败了，不能准确定位到不合规格的图片
    const { url } = value[i]
    const { width, height } = await imageInfo(url)
    if (width !== 1920 || height !== 1276) {
      error = '尺寸限制：1920x1276'
      break
    }
  }
  callback(error)
}
```

2. 上传之前的验证
   `utils.js` 中定义一个公共验证的方法，在需要的时候通过 props 传到上传组件中

```js
// utils.js
export function beforeImageInfo(file) {
  // 无论失败还是成功都需要返回一个  `Promise`
  return new Promise((resolve, reject) => {
    if (!/^image\/[jpeg|png|jpg|gif|svg|ico]/gi.test(file.type)) {
      message.warning('请上传图片类型文件')
      return
    }
    const img = new Image()
    img.src = URL.createObjectURL(file)
    img.onload = function() {
      const { width, height } = this
      resolve({
        height,
        width
      })
    }
    img.onerror = e => {
      message.error('图片加载失败')
      reject(e)
    }
  })
}
```

```js
// 封装的组件中使用验证
async beforeUpload(file) {
      if (file.size / 1000 > this.size) {
        const message = '图片过大';
        this.$message.warning(message);
        return Promise.reject(message);
      }
      if (this.validate) {
        await this.validate(file);
      }
      // 上传之前验证，不通过不上传
      this.formData.token = await qnToken(this.tokenType);
      return true;
    },
```

最后更新日期 2019-03-09
