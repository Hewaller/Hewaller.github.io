---
layout: post
title: wx.loagin
date: 2018-11-25
categories: blog
tags: [JavaScript, 前端, 小程序]
description: 小程序登陆
---

###改变

> 原来我们在首次进入小程序时，会通过 getUserInfo 调起用户授权的弹窗，但是根据微信小程序，最新更新解释，开发工具，体验版本将不再支持这个授权方式而是通过 button 组件让用户自主去点击已完成授权目的（这个对开发者来说真的是很蛋疼）,

> 解决方案： 设置一个用户登陆的过渡页面

```js
  <button wx:if="{{canIUse}}" open-type="getUserInfo" bindgetuserinfo="bindGetUserInfo">授权登录</button>
  <view wx:else>请升级微信版本</view>  //让用户自己去点击这个授权登录的按钮，然后再去进行后续的业务逻辑
```

### 小程序登陆逻辑

```js
import request from '@/utils/request/baseRequest'
import authority from '@/utils/authority' // 将数据存取Storage里
import { getCurrentOptions, getCurrentUrl } from '@/utils'
// 小程序当前页面url和路径参数 和 获取小程序当前路由参数 方法

// code 换取 session_key

async function fetchSessionKey(code) {
  const { session_key, unionid, token, openid = '', user = {} } = await request(
    {
      url: '/api/app/v1/miniapp/session',
      method: 'post',
      data: { code }
    }
  )
  user.session_key = session_key
  user.unionid = unionid
  user.openid = openid
  authority.set(user)
  if (token) {
    user.token = token
    authority.set(user)
    const { back } = getCurrentOptions()
    if (!back) return
    wx.reLaunch({
      url: decodeURIComponent(back)
    })
  } else {
    const back = getCurrentUrl()
    // 重定向对路页面
    if (!back.startsWith('/pages/login/main')) {
      wx.redirectTo({
        url: `/pages/login/main?back=${encodeURIComponent(back)}`
      })
    }
    authority.set({ session_key, unionid })
  }
  return true
}

export default () => {
  return new Promise((resolve, reject) => {
    const user = authority.get() || {}
    if (user.token) return resolve(user) // todo

    const errorHandle = e => {
      console.error(e)
      wx.showToast({
        title: '获取code失败',
        icon: 'none'
      })
      reject(e)
    }

    wx.login({
      success({ code }) {
        fetchSessionKey(code)
          .then(resolve)
          .catch(errorHandle)
      },
      fail(e) {
        console.log(11)
        errorHandle(e)
      }
    })
  })
}
```

> 2018 年 11 月 25 日
